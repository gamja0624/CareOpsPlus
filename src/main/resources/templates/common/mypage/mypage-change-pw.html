<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>CareOps+ | ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</title>
<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
<link th:href="@{/css/web-settings.css}" rel="stylesheet">

	<style>
	.layout-table {
		padding: 40px;
		background-color: #fff;
		border-radius: 10px;
		overflow: auto;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.dropdown-divider { width: auto; }
	
	.info-container {
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 30px;
		width: 60%;
	}
	
	.info-row {
		display: flex;
		align-items: center;
		gap: 10px;
		width: 100%;
	}
	
	label {
		font-weight: 500; /* ê¸°ë³¸ í°íŠ¸ êµµê¸° */
		color: #666;
		font-size: 23px;
		width: 150px; /* ë¼ë²¨ ë„ˆë¹„ ì¦ê°€ */
		text-align: left; /* ì™¼ìª½ ì •ë ¬ */
		white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
	}
	
	.info-field {
		flex: 1;
		padding: 10px;
		margin-bottom: 15px;
		border-radius: 4px;
		border: 1px solid #13254C;
		background-color: #13254C;
		color: #fff;
		font-size: 20px;
		box-sizing: border-box;
		width: calc(100% - 160px);
		font-weight: 600;
	}
	
	.btn {
		padding: 12px;
		background-color: #13254C;
		color: white;
		font-size: 18px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		transition: background-color 0.3s;
		width: 48%;
		font-weight: 700;
	}
	
	hr {
		width: 60%;
		margin: 2rem 0;
		background-color: #000;
		height: 1px;
		border: 0;
	}
	
	.btn:hover { background-color: #1a3366; }
	
	.btn-container {
		width: 60%;
		display: flex;
		justify-content: space-between;
		margin-top: 30px;
	}
	
	.password-container {
		position: relative;
		display: flex;
		align-items: center;
		width: 100%;
	}
	
	.toggle-password {
		position: absolute;
		right: 5px;
		transform: translateY(-50%);
		background: none;
		border: none;
		cursor: pointer;
	}
	
	/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
	.modal.fade .modal-dialog { transform: translate(-50%, -92%) !important; }
	.modal-content {
		background-color: white;
		color: #ff0000;
		border-radius: 10px;
		padding: 20px;
		border: none;
		margin: 0 auto;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
	}
	
	.modal-dialog {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 90%;
		max-width: 550px;
		margin: 0;
	}
	
	.modal-header { border-bottom: none; padding: 0 0 15px 0; }
	.modal-title { font-size: 18px;}	
	.modal-body { padding: 15px 0; font-size: 20px; text-align: center; }
	.modal-footer { border-top: none; padding: 15px 0 0 0; justify-content: center; }
	
	.btn-close {
		position: absolute;
		right: 20px;
		top: 20px;
		font-size: 24px;
		font-weight: 700;
		opacity: 0.5;
	}
	
	.btn-close:hover { opacity: 1; }
	
	/* ëª¨ë‹¬ ë°°ê²½ ìŠ¤íƒ€ì¼ */
	.modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
	
	/* ëª¨ë‹¬ì´ í™”ë©´ ë§¨ ìœ„ë¡œ ì˜¤ë„ë¡ z-index ì¡°ì • */
	.modal { z-index: 1050; }
	
	.modal-backdrop { z-index: 1040; }
	
	/* ëª¨ë‹¬ ë‚´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.modal-footer .btn { font-size: 16px; }
	
</style>
</head>

<body>
	<!-- ì‚¬ì´ë“œë°” -->
	<th:block th:replace="~{/common/side-bar}"></th:block>

	<!-- ì»¨í…ì¸  ì˜ì—­ -->
	<div class="content">
		<div class="section">
			<h1 class="title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h1>
			<form id="passwordChangeForm" th:action="@{/mypage-change-pw}"
				method="post">
				<div class="layout-table">
					<hr>
					<div class="info-container">
						<div class="info-row">
							<label for="current_password">ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label>
							<div class="password-container">
								<input type="password" id="current_password"
									name="currentPassword" class="info-field"
									th:value="${currentPassword}" readonly>
								<button type="button" class="toggle-password"
									onclick="togglePassword('current_password')">ğŸ”</button>
							</div>
						</div>
						<div class="info-row">
							<label for="new_password">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸</label>
							<div class="password-container">
								<input type="password" id="new_password" name="newPassword"
									class="info-field" required>
								<button type="button" class="toggle-password"
									onclick="togglePassword('new_password')">ğŸ”</button>
							</div>
						</div>
						<div class="info-row">
							<label for="confirm_password">ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥</label>
							<div class="password-container">
								<input type="password" id="confirm_password"
									name="confirmPassword" class="info-field" required>
								<button type="button" class="toggle-password"
									onclick="togglePassword('confirm_password')">ğŸ”</button>
							</div>
						</div>
					</div>
					<hr>
					<div class="btn-container">
						<button type="button" class="btn"
							onclick="window.location.href='/mypage'">ë’¤ë¡œê°€ê¸°</button>
						<button type="button" class="btn" onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸
							ë³€ê²½</button>
					</div>
				</div>
			</form>
		</div>
		
		<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨ ëª¨ë‹¬ -->
		<div class="modal fade" id="passwordChangeErrorModal" tabindex="-1"
			role="dialog" aria-labelledby="passwordChangeErrorModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="passwordChangeErrorModalLabel">ë¹„ë°€ë²ˆí˜¸
							ë³€ê²½ ì˜¤ë¥˜</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body text-center">
						<p id="passwordChangeErrorMessage"></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary"
							data-bs-dismiss="modal">ë‹«ê¸°</button>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
	  // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œì˜ ê°€ì‹œì„±ì„ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
		function togglePassword(inputId) {
		    var input = document.getElementById(inputId);
		    // í˜„ì¬ íƒ€ì…ì´ 'password'ì´ë©´ 'text'ë¡œ, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ 'password'ë¡œ ë³€ê²½
		    if (input.type === "password") {
		        input.type = "text";
		    } else {
		        input.type = "password";
		    }
		}
	  
		// ì¤‘ë³µ ì œì¶œ ë°©ì§€ë¥¼ ìœ„í•œ flag (flagëŠ” boolean true,falseì˜ê°’ì„ ê°€ì§„ ë³€ìˆ˜)
		// ì´ ë³€ìˆ˜ëŠ” í¼ì´ í˜„ì¬ ì œì¶œ ì¤‘ì¸ì§€ ì•„ë‹Œì§€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.
		// trueì¼ ê²½ìš° ì œì¶œ ì¤‘, falseì¼ ê²½ìš° ì œì¶œ ê°€ëŠ¥í•œ ìƒíƒœ.
		let isSubmitting = false;

		// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•¨ìˆ˜
		function changePassword() {
			// ì´ë¯¸ ì œì¶œ ì¤‘ì´ë©´ í•¨ìˆ˜ ì‹¤í–‰ì„ ì¤‘ë‹¨
			// ì´ëŠ” ì‚¬ìš©ìê°€ ì—¬ëŸ¬ë²ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ëŠ” ê²ƒ ë°©ì§€
			if (isSubmitting) {
				console.log('ì´ë¯¸ ì œì¶œ ì¤‘ì…ë‹ˆë‹¤.');
				return;
			}
			 
			// ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ ê°’ì„ ê°€ì ¸ì˜´
			var newPassword = document.getElementById('new_password').value;
			var confirmPassword = document.getElementById('confirm_password').value;

			// ë¹„ë°€ë²ˆí˜¸ í•„ë“œê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
			if (!newPassword || !confirmPassword) {
				showPasswordChangeError('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
				return;
			}

			// ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
			if (newPassword !== confirmPassword) {
				showPasswordChangeError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
				return;
			}

			// ì œì¶œ ì¤‘ í”Œë˜ê·¸ë¥¼ trueë¡œ ì„¤ì •
			// ì´ì œ í¼ì´ ì œì¶œ ì¤‘ì„ì„ ë‚˜íƒ€ë‚¸ë‹¤.
			isSubmitting = true;

			// AJAXë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì— ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­
			$.ajax({
				url : '/mypage-change-pw',
				type : 'POST',
				data : JSON.stringify({
					newPassword : newPassword,
					confirmPassword : confirmPassword
				}),
				contentType : 'application/json',
				dataType : 'json',
				success : function(response) {
					// ìš”ì²­ ì™„ë£Œ í›„ ì œì¶œ ì¤‘ í”Œë˜ê·¸ë¥¼ falseë¡œ ì„¤ì •
					// ì´ì œ ë‹¤ì‹œ í¼ì„ ì œì¶œí• ìˆ˜ìˆëŠ” ìƒíƒœê°€ ëœë‹¤.
					isSubmitting = false;
					if (response.success) {
						alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
						window.location.href = '/mypage';
					} else {
						// ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
						showPasswordChangeError(response.message);
					}
				},
				error : function(xhr, status, error) {
					// ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì œì¶œ ì¤‘ í”Œë˜ê·¸ë¥¼ falseë¡œ ì„¤ì •
					// ì—ëŸ¬ê°€ ë‹¤ì‹œ ë°œìƒí•´ë„ ë‹¤ì‹œ í¼ì„ ì œì¶œí•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
					isSubmitting = false;
					// ì—ëŸ¬ ë¡œê·¸ë¥¼ ì½˜ì†”ì— ì¶œë ¥
					console.error('Error:', xhr.responseText);
					// ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
					showPasswordChangeError('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				}
			});
		}

		// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ëª¨ë‹¬ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
		function showPasswordChangeError(message) {
			// ì—ëŸ¬ ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì„¤ì •
			$('#passwordChangeErrorMessage').text(message);
			// ì—ëŸ¬ ëª¨ë‹¬ í‘œì‹œ
			$('#passwordChangeErrorModal').modal('show');
		}
	</script>
</body>
</html>
