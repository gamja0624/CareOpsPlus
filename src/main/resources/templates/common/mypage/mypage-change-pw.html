
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>CareOps+ | ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</title>
<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
<link th:href="@{/css/web-settings.css}" rel="stylesheet">

	<style>
	.layout-table {
		padding: 40px;
		background-color: #fff;
		border-radius: 10px;
		overflow: auto;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.dropdown-divider { width: auto; }
	
	.info-container {
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 30px;
		width: 60%;
	}
	
	.info-row {
		display: flex;
		align-items: center;
		gap: 10px;
		width: 100%;
	}
	
	label {
		font-weight: 500; /* ê¸°ë³¸ í°íŠ¸ êµµê¸° */
		color: #666;
		font-size: 23px;
		width: 150px; /* ë¼ë²¨ ë„ˆë¹„ ì¦ê°€ */
		text-align: left; /* ì™¼ìª½ ì •ë ¬ */
		white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
	}
	
	.info-field {
		flex: 1;
		padding: 10px;
		margin-bottom: 15px;
		border-radius: 4px;
		border: 1px solid #13254C;
		background-color: #13254C;
		color: #fff;
		font-size: 20px;
		box-sizing: border-box;
		width: calc(100% - 160px);
		font-weight: 600;
	}
	
	.btn {
	    padding: 12px;
	    background-color: #13254C;
	    color: white;
	    font-size: 18px;
	    border: 2px solid transparent; /* ì´ˆê¸° border ì„¤ì • */
	    border-radius: 10px;
	    cursor: pointer;
	    transition: background-color 0.3s, border-color 0.3s; /* ë°°ê²½ìƒ‰ê³¼ í…Œë‘ë¦¬ ìƒ‰ìƒì— ëŒ€í•œ ì „í™˜ */
	    width: 48%;
	    font-weight: 700;
	    box-sizing: border-box; /* border-box ì„¤ì • */
	}
	
	hr {
		width: 60%;
		margin: 2rem 0;
		background-color: #000;
		height: 1px;
		border: 0;
	}
	
	.btn:hover { border-color: #13254C; background-color: white; color: #13254C } 
	
	.btn-container {
		width: 60%;
		display: flex;
		justify-content: space-between;
		margin-top: 30px;
	}
	
	.password-container {
		position: relative;
		display: flex;
		align-items: center;
		width: 100%;
	}
	
	.toggle-password {
		position: absolute;
		right: 5px;
		transform: translateY(-50%);
		background: none;
		border: none;
		cursor: pointer;
	}
	
	/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
	.modal.fade .modal-dialog { transform: translate(-50%, -89%) !important; }
	.modal-content {
		background-color: white;
		border-radius: 10px;
			border: none;
		margin: 0 auto;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
	}
	
	.modal-dialog {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 90%;
		max-width: 550px;
		margin: 0;
	}
	
	.modal-header { border-bottom: none; background-color: #13254C; color:white; }
	.modal-title { font-size: 18px;}	
	.modal-body { padding: 15px 0; font-size: 20px; text-align: center; color: black; }
	.modal-footer { border-top: none; padding: 15px 0 0 0; justify-content: center; background-color: #f1f1f1;}
	
	/* ëª¨ë‹¬ ë°°ê²½ ìŠ¤íƒ€ì¼ */
	.modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
	
	/* ëª¨ë‹¬ì´ í™”ë©´ ë§¨ ìœ„ë¡œ ì˜¤ë„ë¡ z-index ì¡°ì • */
	.modal { z-index: 1050; }
	.modal-backdrop { z-index: 1040; }
	
	/* ëª¨ë‹¬ ë‚´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.modal-footer .btn { font-size: 16px; background-color: #13254C; border-color: #fff; }
	
</style>
</head>

<body>
	<!-- ì‚¬ì´ë“œë°” -->
	<th:block th:replace="~{/common/side-bar}"></th:block>

	<!-- ì»¨í…ì¸  ì˜ì—­ -->
	<div class="content">
		<div class="section">
			<h1 class="title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h1>
			<form id="passwordChangeForm" th:action="@{'/' + ${userType} + '/mypage-change-pw'}" method="post">
				<div class="layout-table">
					<hr>
					<div class="info-container">
						<div class="info-row">
							<label for="current_password">ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label>
							<div class="password-container">
								<input type="password" id="current_password"
									name="currentPassword" class="info-field"
									th:value="${currentPassword}" readonly>
								<button type="button" class="toggle-password"
									onclick="togglePassword('current_password')">ğŸ”</button>
							</div>
						</div>
						<div class="info-row">
							<label for="new_password">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸</label>
							<div class="password-container">
								<input type="password" id="new_password" name="newPassword"
									class="info-field" required>
								<button type="button" class="toggle-password"
									onclick="togglePassword('new_password')">ğŸ”</button>
							</div>
						</div>
						<div class="info-row">
							<label for="confirm_password">ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥</label>
							<div class="password-container">
								<input type="password" id="confirm_password"
									name="confirmPassword" class="info-field" required>
								<button type="button" class="toggle-password"
									onclick="togglePassword('confirm_password')">ğŸ”</button>
							</div>
						</div>
					</div>
					<hr>
					<div class="btn-container">
						<button type="button" class="btn" onclick="goToDashboard()">ë’¤ë¡œê°€ê¸°</button>
						<button type="button" class="btn" onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸
							ë³€ê²½</button>
					</div>
				</div>
			</form>
		</div>
		
		<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨ ëª¨ë‹¬ -->
		<div class="modal fade" id="passwordChangeErrorModal" tabindex="-1"
			role="dialog" aria-labelledby="passwordChangeErrorModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="passwordChangeErrorModalLabel">ë¹„ë°€ë²ˆí˜¸
							ë³€ê²½ ì˜¤ë¥˜</h5>
					</div>
					<div class="modal-body text-center">
						<p id="passwordChangeErrorMessage"></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary"
							data-bs-dismiss="modal">ë‹«ê¸°</button>
					</div>
				</div>
			</div>
		</div>
		
		<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ ëª¨ë‹¬ -->
		<div class="modal fade" id="passwordChangeSuccessModal" tabindex="-1" role="dialog" aria-labelledby="passwordChangeSuccessModalLabel" aria-hidden="true">
		    <div class="modal-dialog modal-dialog-centered" role="document">
		        <div class="modal-content">
		            <div class="modal-header">
		                <h5 class="modal-title" id="passwordChangeSuccessModalLabel">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ</h5>
		                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		            </div>
		            <div class="modal-body text-center">
		                <p>ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
		            </div>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-primary" onclick="redirectToMyPage()">í™•ì¸</button>
		            </div>
		        </div>
		    </div>
		</div>

	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">

		var userType = /*[[${userType}]]*/
		
		// ì‚¬ì´ë“œë°” dropup ì´ˆê¸°í™”
		$(document).ready(function() {
		    $('.dropup-toggle').dropdown();
		});
		
		// ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
		function isValidPassword(password) {
		    const regex = /^(?=.*[a-z])(?=.*[A-Z0-9]).{10,16}$/;
		    return regex.test(password);
		}

		// ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ê°€ì‹œì„± í† ê¸€ í•¨ìˆ˜
		function togglePassword(fieldId) {
		    const field = document.getElementById(fieldId);
		    field.type = field.type === "password" ? "text" : "password";
		}

		// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•¨ìˆ˜
		let isSubmitting = false;

		function changePassword() {
		    const currentPassword = $('#current_password').val();
		    const newPassword = $('#new_password').val();
		    const confirmPassword = $('#confirm_password').val();

		    // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ë¹„ì–´ ìˆëŠ”ì§€ í™•ì¸
		    if (!currentPassword) {
		        showPasswordChangeError('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		        return;
		    }

		    // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
		    if (!isValidPassword(newPassword)) {
		        showPasswordChangeError('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 10ì, ìµœëŒ€ 16ìì´ë©° ì†Œë¬¸ì, ëŒ€ë¬¸ì ë˜ëŠ” ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.');
		        return;
		    }

		    // ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥ ê°’ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
		    if (newPassword !== confirmPassword) {
		        showPasswordChangeError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
		        return;
		    }

		    isSubmitting = true;

		    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­
			    $.ajax({
					url: '/' + userType + '/mypage-change-pw',  // userType ë³€ìˆ˜ ì‚¬ìš©
			        type: 'POST',
			        contentType: 'application/json',
			        data: JSON.stringify({
			            currentPassword: currentPassword,
			            newPassword: newPassword,
			            confirmPassword: confirmPassword
			        }),
			        success: function(response) {
			            if (response.success) {
			                $('#passwordChangeSuccessModal').modal('show');
			            } else {
			                showPasswordChangeError(response.message);
			            }
			        },
					error: function(xhr, status, error) {
					    console.error("Error details:", xhr.responseText);
					    showPasswordChangeError(xhr.responseJSON?.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
					}
			    });
			}

		// ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
		function showPasswordChangeError(message) {
		    $('#passwordChangeErrorMessage').text(message);
		    $('#passwordChangeErrorModal').modal('show');
		}

		// ì„±ê³µ ëª¨ë‹¬ì„ ë‹«ê³  mypageë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” í•¨ìˆ˜
		function redirectToMyPage() {
		    window.location.href = '/' + userType + '/dash-board';
		}
		
		function goToDashboard() {
		    window.location.href = '/' + userType + '/dash-board';
		}
	</script>
</body>
</html>
